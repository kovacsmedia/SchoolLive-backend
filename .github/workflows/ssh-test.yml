name: SSH connectivity test

on:
  workflow_dispatch: {}   # Kézzel indítható a Actions fülön

jobs:
  ssh-test:
    runs-on: ubuntu-latest
    steps:
      - name: Trust host key
        run: |
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: SSH to server and run commands
        uses: appleboy/ssh-action@v1.2.0
        with:
          host:     ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key:      ${{ secrets.DEPLOY_KEY }}
          script: |
            echo "Connected to: $(hostname)"
            echo "User: $(whoami)"
            echo "Uptime: $(uptime)"
            mkdir -p /opt/schoollive/_probe
            echo "OK $(date)" > /opt/schoollive/_probe/ok.txt
            ls -la /opt/schoollive/_probe
