// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  ORG_ADMIN
  TEACHER
  OPERATOR
  PLAYER
}

enum DeviceAuthType {
  KEY
  JWT
}

enum MessageType {
  TTS
  AUDIO_FILE
  YOUTUBE
  PLAYLIST
}

enum TargetType {
  DEVICE
  GROUP
  ORG_UNIT
  ALL
}

enum CommandStatus {
  QUEUED
  SENT
  ACKED
  FAILED
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  domain    String?  @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  orgUnits  OrganizationalUnit[]
  users     User[]
  devices   Device[]
  groups    DeviceGroup[]
  messages  Message[]
  commands  DeviceCommand[]

  @@index([isActive])
}

model OrganizationalUnit {
  id        String  @id @default(uuid())
  tenantId  String
  name      String
  parentId  String?

  tenant    Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent    OrganizationalUnit? @relation("OrgUnitTree", fields: [parentId], references: [id])
  children  OrganizationalUnit[] @relation("OrgUnitTree")

  users     User[]
  devices   Device[]

  @@index([tenantId])
  @@index([tenantId, parentId])
  @@unique([tenantId, name])
}

model User {
  id        String   @id @default(uuid())
  tenantId  String?  // SUPER_ADMIN esetén lehet null
  orgUnitId String?

  email        String   @unique
  passwordHash String
  role         UserRole
  isActive     Boolean  @default(true)

  // 2FA (TOTP)
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?

  // Trusted device (a superadmin "eszközhöz kötése")
  trustedDeviceHash  String?
  trustedDeviceSetAt DateTime?

  lastLoginAt DateTime?
  createdAt   DateTime @default(now())

  tenant   Tenant?             @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  orgUnit  OrganizationalUnit? @relation(fields: [orgUnitId], references: [id], onDelete: SetNull)

  messages Message[] @relation("CreatedBy")

  // ✅ web-player “device”-ok (JWT authType)
  devices  Device[]

  @@index([tenantId])
  @@index([role])
  @@index([isActive])
}

model Device {
  id            String   @id @default(uuid())
  tenantId      String
  orgUnitId     String?

  serialNumber    String? @unique
  installCodeHash String? // bcrypt hash, mint a deviceKeyHash

  name String

  // ✅ AUTH:
  authType     DeviceAuthType @default(KEY)
  deviceKeyHash String?       // KEY esetén kötelezően kitöltjük alkalmazás-logikával

  // ✅ JWT-es “virtual device” támogatás
  clientId String?
  userId   String?

  firmwareVersion String?
  ipAddress       String?

  // állapot
  lastSeenAt DateTime?
  online     Boolean  @default(false)

  volume Int     @default(5)  // 0..10
  muted  Boolean @default(false)

  // bővíthető státusz
  statusPayload Json?

  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orgUnit OrganizationalUnit? @relation(fields: [orgUnitId], references: [id], onDelete: SetNull)

  // ✅ JWT-es device tulajdonosa (PLAYER user)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  groupMembers     DeviceGroupMember[]
  commands         DeviceCommand[]
  provisionSessions DeviceProvisionSession[]

  @@index([tenantId])
  @@index([tenantId, online])
  @@index([tenantId, lastSeenAt])
  @@index([userId])

  @@unique([tenantId, name])
  @@unique([tenantId, clientId])
}

model DeviceGroup {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  createdAt DateTime @default(now())

  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members DeviceGroupMember[]

  @@index([tenantId])
  @@unique([tenantId, name])
}

model DeviceGroupMember {
  groupId  String
  deviceId String

  group  DeviceGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  device Device      @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@id([groupId, deviceId])
  @@index([deviceId])
}

model Message {
  id          String      @id @default(uuid())
  tenantId    String
  type        MessageType
  title       String?
  fileUrl     String?
  scheduledAt DateTime?

  targetType TargetType
  targetId   String? // DEVICE/GROUP/ORG_UNIT esetén

  createdById String
  createdAt   DateTime @default(now())

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User   @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  commands DeviceCommand[]

  @@index([tenantId])
  @@index([tenantId, scheduledAt])
  @@index([tenantId, targetType])
}

model DeviceCommand {
  id        String   @id @default(uuid())
  tenantId  String
  deviceId  String
  messageId String?
  payload   Json

  status   CommandStatus @default(QUEUED)
  queuedAt DateTime      @default(now())
  sentAt   DateTime?
  ackedAt  DateTime?
  error    String?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  message Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([deviceId])
  @@index([tenantId, status])
  @@index([tenantId, queuedAt])

  retryCount Int @default(0)
  maxRetries Int @default(3)
  lastError  String?
}

model DeviceProvisionSession {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  deviceId  String
  tenantId  String?

  name         String
  wifiSsid     String
  wifiPassword String
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([expiresAt])
}